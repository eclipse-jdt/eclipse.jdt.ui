name: Rebase Upstream

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened]

jobs:
  add-rebase-button:
    name: Add Rebase Instructions
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add comment with rebase instructions
        uses: actions/github-script@v8
        with:
          script: |
            const repoUrl = context.payload.repository.html_url;
            const workflowUrl = `${repoUrl}/actions/workflows/rebase-upstream.yml`;
            
            const comment = `## üîÑ Rebase onto Upstream
            
            To rebase this PR onto the latest \`eclipse-jdt/eclipse.jdt.ui:master\`, comment:
            
            \`\`\`
            /rebase-upstream
            \`\`\`
            
            This will rebase your PR branch onto the upstream repository's master branch.
            
            üìã [View Workflow](${workflowUrl})`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  rebase-upstream:
    name: Rebase onto Upstream Master
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/rebase-upstream')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check user permission
        id: check
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            const authorAssociation = context.payload.comment.author_association;
            const allowedRoles = ['OWNER', 'MEMBER', 'COLLABORATOR'];
            
            if (allowedRoles.includes(authorAssociation)) {
              return 'true';
            } else {
              return 'false';
            }

      - name: Add unauthorized reaction
        if: steps.check.outputs.result != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå Only repository collaborators can trigger the rebase.'
            });

      - name: Exit if unauthorized
        if: steps.check.outputs.result != 'true'
        run: exit 1

      - name: Add rocket reaction
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR branch info
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('head_clone_url', pr.head.repo.clone_url);
            
            // Get the number of commits in the PR
            // Note: per_page is set to 250, which covers most PRs.
            // For PRs with >250 commits, manual rebasing would be required.
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 250
            });
            core.setOutput('commit_count', commits.length);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.head_repo }}
          ref: ${{ steps.pr.outputs.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and rebase
        id: rebase
        run: |
          git remote add upstream https://github.com/eclipse-jdt/eclipse.jdt.ui.git
          git fetch upstream master
          
          # Get the number of commits in the PR
          PR_COMMIT_COUNT=${{ steps.pr.outputs.commit_count }}
          echo "PR has $PR_COMMIT_COUNT commits"
          
          # Validate commit count
          if [ "$PR_COMMIT_COUNT" -eq 0 ]; then
            echo "Error: PR has 0 commits"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Rebase only the PR commits onto upstream/master
          if git rebase --onto upstream/master HEAD~${PR_COMMIT_COUNT}; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            git rebase --abort
          fi

      - name: Push rebased branch
        if: steps.rebase.outputs.success == 'true'
        run: |
          git push --force-with-lease origin ${{ steps.pr.outputs.head_ref }}

      - name: Add success comment
        if: steps.rebase.outputs.success == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Successfully rebased onto `eclipse-jdt/eclipse.jdt.ui:master`'
            });

      - name: Add failure comment
        if: steps.rebase.outputs.success == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
            
            const comment = `‚ùå Rebase failed due to conflicts.
            
            To resolve manually:
            
            \`\`\`bash
            # Add upstream remote
            git remote add upstream https://github.com/eclipse-jdt/eclipse.jdt.ui.git
            
            # Fetch upstream
            git fetch upstream master
            
            # Count the number of commits in your PR (check GitHub PR page)
            # For example, if your PR has 3 commits:
            PR_COMMIT_COUNT=3
            
            # Rebase only your PR commits onto upstream/master
            git rebase --onto upstream/master HEAD~\${PR_COMMIT_COUNT}
            
            # Resolve conflicts, then:
            git add .
            git rebase --continue
            
            # Force push when done
            git push --force-with-lease
            \`\`\``;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail workflow if rebase failed
        if: steps.rebase.outputs.success == 'false'
        run: exit 1
